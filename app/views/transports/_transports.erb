<table class="table table-striped">
  <thead>
    <tr>
      <th>Transport</th>
      <th>Listed by</th>
      <th>Outbound departure time</th>
      <th>Return departure time</th>
      <th>Cost</th>
      <th>Places taken</th>
      <th></th>
      <th>People</th> 
    </tr>
  </thead>
  <% @gathering.transports.order('name asc').each { |transport| %>
    <tr>
      <td>
        <a href="/a/<%=@gathering.slug%>/transports/<%=transport.id%>/edit">
          <%=transport.name%>
        </a>          
        <br />
        <%= transport.description %>        
      </td>
      <td>
        <%= partial :'accounts/square', :locals => {:account => transport.account, :width => '50px'} %>
      </td>
      <td>
        <%= transport.outbound_departure_time %>
      </td>
      <td>
        <%= transport.return_departure_time %>
      </td>
      <td>
        <% if transport.cost && transport.cost > 0 %>
          <%=@gathering.currency_symbol%><%=transport.cost%>
        <% else %>
          Arrange with driver
        <% end %>
      </td>
      <td>
        <%=transport.transportships.count%>/<%= transport.capacity %>
        <% if transport.full? %>
          <span class="label label-danger">Full</span>
        <% else %>
          <span class="label label-success">Spaces</span>
        <% end %>        
      </td>
      <td>
        <% if transportship = @gathering.transportships.find_by(transport: transport, account: current_account) %>
          <a class="pagelet-trigger btn btn-primary" href="/transportships/<%=transportship.id%>/destroy">Leave</a>
        <% elsif !transport.full? %>
          <a class="pagelet-trigger btn btn-primary" href="/transportships/create?transport_id=<%=transport.id%>">Join</a>
        <% end %>       
      </td>      
      <td>  
        <% y = [] %>
        <% transport.transportships.each { |transportship| account = transportship.account; %>
          <% if params[:view] == 'names' %>
            <% y << capture do %>   
              <%= account.name %>
            <% end %>
          <% else %>
            <% y << capture do %>
              <%= partial :'accounts/square', :locals => {:account => account, :width => '50px'} %>
            <% end %>
          <% end %>
        <% } %>
        <% if params[:view] == 'names' %>
          <%= y.map(&:strip).join(', ') %>
        <% else %>
          <div class="image-wall">
            <%= y.map(&:strip).join('') %>
          </div>
        <% end %>
      </td>
    </tr>
  <% } %>
</table>

<% if params[:view] != 'names' %>
  <a onclick="$(this).closest('[data-pagelet-url]').attr('data-pagelet-url', '/a/<%=@gathering.slug%>/transports?view=names')" href="#" class="pagelet-trigger">Show names instead of pictures</a>
<% end %>
